{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
  {{ block.super }}
  <style>
    .ai-blog-editor-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      padding: 20px;
    }
    
    .chat-container {
      flex: 1;
      min-width: 300px;
      max-width: 500px;
      display: flex;
      flex-direction: column;
      border: 1px solid #ddd;
      border-radius: 5px;
      overflow: hidden;
    }
    
    .chat-messages {
      flex: 1;
      min-height: 400px;
      max-height: 70vh;
      overflow-y: auto;
      padding: 15px;
      background-color: #f5f5f5;
    }
    
    .message {
      margin-bottom: 15px;
      padding: 10px 15px;
      border-radius: 5px;
      max-width: 85%;
      word-break: break-word;
    }
    
    .message.user {
      background-color: #007bff;
      color: white;
      align-self: flex-end;
      margin-left: auto;
    }
    
    .message.ai {
      background-color: #e9ecef;
      color: #212529;
      align-self: flex-start;
    }
    
    .message.system {
      background-color: #ffc107;
      color: #212529;
      width: 100%;
      max-width: 100%;
      text-align: center;
      font-style: italic;
    }
    
    .chat-input {
      display: flex;
      padding: 10px;
      background-color: #fff;
      border-top: 1px solid #ddd;
    }
    
    .chat-input textarea {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-height: 60px;
      resize: vertical;
    }
    
    .chat-input button {
      padding: 0 20px;
      margin-left: 10px;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .editor-container {
      flex: 2;
      min-width: 500px;
      display: flex;
      flex-direction: column;
    }
    
    .editor-tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
    }
    
    .editor-tab {
      padding: 10px 15px;
      cursor: pointer;
      border: 1px solid transparent;
      border-radius: 5px 5px 0 0;
      background-color: #f8f9fa;
      margin-right: 5px;
    }
    
    .editor-tab.active {
      background-color: #fff;
      border-color: #ddd;
      border-bottom-color: #fff;
      z-index: 1;
      margin-bottom: -1px;
    }
    
    .editor-content {
      flex: 1;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    
    .editor-content.side-by-side {
      display: flex;
      padding: 0;
      gap: 15px;
      min-height: 500px;
    }
    
    .editor-pane, .preview-pane {
      flex: 1;
      display: flex;
      flex-direction: column;
      border: 1px solid #ddd;
      border-radius: 5px;
      overflow: hidden;
    }
    
    .pane-header {
      padding: 10px 15px;
      background-color: #f8f9fa;
      border-bottom: 1px solid #ddd;
      font-weight: bold;
      color: #495057;
    }
    
    .editor-textarea {
      width: 100%;
      flex: 1;
      border: none;
      padding: 15px;
      font-family: monospace;
      resize: none;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .button-group {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
    }
    
    .button-group button {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .button-group button.primary {
      background-color: #007bff;
      color: white;
    }
    
    .button-group button.secondary {
      background-color: #6c757d;
      color: white;
    }
    
    .button-group button.success {
      background-color: #28a745;
      color: white;
    }
    
    .loading-spinner {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .preview-container {
      margin-top: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 20px;
      background-color: #fff;
    }
    
    .preview-container h2 {
      margin-top: 0;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    
    .preview-content {
      background-color: #fff;
      padding: 15px;
      flex: 1;
      overflow-y: auto;
      line-height: 1.6;
    }
    
    .preview-content img {
      max-width: 100%;
    }
    
    .preview-content h1, .preview-content h2, .preview-content h3 {
      margin-top: 0.5em;
      margin-bottom: 0.5em;
    }
    
    .preview-content code {
      background-color: #f5f5f5;
      padding: 2px 4px;
      border-radius: 3px;
      font-family: monospace;
    }
    
    .preview-content pre {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
    }
    
    /* Modal styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal-content {
      background-color: #fff;
      border-radius: 5px;
      width: 80%;
      max-width: 800px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid #ddd;
    }
    
    .modal-header h3 {
      margin: 0;
    }
    
    .close-modal {
      font-size: 24px;
      cursor: pointer;
      color: #aaa;
    }
    
    .close-modal:hover {
      color: #333;
    }
    
    .modal-body {
      padding: 15px;
      overflow-y: auto;
      flex: 1;
    }
    
    /* Version history styles */
    .version-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .version-item {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .version-item:hover {
      background-color: #f5f5f5;
    }
    
    .version-item.active {
      background-color: #e3f2fd;
      border-left: 3px solid #2196F3;
    }
    
    .version-info {
      flex: 1;
    }
    
    .version-time {
      color: #666;
      font-size: 0.9em;
    }
    
    .version-actions {
      display: flex;
      gap: 5px;
    }
    
    /* Diff view styles */
    .diff-container {
      margin-top: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
      overflow: hidden;
    }
    
    .diff-header {
      padding: 10px 15px;
      background-color: #f8f9fa;
      border-bottom: 1px solid #ddd;
    }
    
    .diff-header h4 {
      margin: 0 0 10px 0;
    }
    
    .diff-legend {
      display: flex;
      gap: 15px;
      font-size: 0.9em;
    }
    
    .diff-removed {
      color: #d32f2f;
      position: relative;
      padding-left: 15px;
    }
    
    .diff-removed::before {
      content: "-";
      position: absolute;
      left: 0;
      font-weight: bold;
    }
    
    .diff-added {
      color: #388e3c;
      position: relative;
      padding-left: 15px;
    }
    
    .diff-added::before {
      content: "+";
      position: absolute;
      left: 0;
      font-weight: bold;
    }
    
    .diff-content {
      max-height: 400px;
      overflow-y: auto;
      background-color: #fff;
      font-family: monospace;
      font-size: 13px;
      line-height: 1.5;
      padding: 10px 0;
    }
    
    .diff-line {
      padding: 2px 15px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    
    .diff-line.diff-removed {
      background-color: #ffebee;
      text-decoration: line-through;
    }
    
    .diff-line.diff-added {
      background-color: #e8f5e9;
    }
    
    .diff-actions {
      padding: 10px 15px;
      background-color: #f8f9fa;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .diff-actions button {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .diff-actions .restore-version {
      background-color: #2196F3;
      color: white;
    }
    
    .diff-actions .close-diff {
      background-color: #6c757d;
      color: white;
    }
    
    .diff-highlight {
      background-color: #ffffcc;
    }
    
    .blog-metadata {
      margin-bottom: 20px;
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      border-left: 4px solid #007bff;
    }
    
    .blog-metadata h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #495057;
    }
    
    .metadata-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .metadata-form .field {
      display: flex;
      flex-direction: column;
    }
    
    .metadata-form label {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .metadata-form select,
    .metadata-form input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
  </style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
  <a href="{% url 'admin:index' %}">Home</a>
  &rsaquo; <a href="{% url 'admin:app_list' app_label='blog' %}">Blog</a>
  &rsaquo; AI Blog Editor
</div>
{% endblock %}

{% block content %}
<div class="module aligned">
  <h1>AI Blog Editor</h1>
  
  {% if not api_key_configured %}
    <div class="errornote">
      <h3>API Key Not Configured</h3>
      <p>The Anthropic API key is required for AI-powered blog editing.</p>
      <p>To set up your API key:</p>
      <ol>
        <li>Go to the <a href="/admin/api-key-setup/">API Key Setup page</a></li>
        <li>Enter your Anthropic API key in the form</li>
        <li>Save the key to enable AI-powered editing</li>
      </ol>
      <a href="/admin/api-key-setup/" class="button" style="background-color: #28a745;">
        Configure API Key
      </a>
    </div>
  {% else %}
  
  <div class="ai-blog-editor-container">
    <!-- Chat container -->
    <div class="chat-container">
      <div class="chat-messages" id="chatMessages">
        <div class="message ai">
          <p>Hello! I'm your AI blog post assistant. Tell me what you'd like to write about, and I'll help you create a fantastic blog post. You can ask for specific changes, suggestions, or guidance at any point.</p>
        </div>
      </div>
      
      <div class="chat-input">
        <textarea id="userInput" placeholder="Describe your blog post idea or ask for help..."></textarea>
        <button id="sendButton">Send</button>
      </div>
    </div>
    
    <!-- Editor container -->
    <div class="editor-container">
      <!-- Blog post metadata -->
      <div class="blog-metadata">
        <h3>Blog Post Details</h3>
        <div class="metadata-form">
          <div class="field">
            <label for="postTitle">Title</label>
            <input type="text" id="postTitle" name="title" placeholder="Enter blog post title">
          </div>
          
          <div class="field">
            <label for="postCategory">Category</label>
            <select id="postCategory" name="category">
              <option value="">-- Select Category --</option>
              {% for category in categories %}
                <option value="{{ category.id }}">{{ category.name }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="field">
            <label for="postAuthor">Author</label>
            <select id="postAuthor" name="author">
              {% for author in authors %}
                <option value="{{ author.id }}">{{ author.get_full_name|default:author.username }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="field">
            <label for="postStatus">Status</label>
            <select id="postStatus" name="status">
              <option value="draft">Draft</option>
              <option value="published">Published</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Side-by-side editor and preview -->
      <div class="editor-content side-by-side">
        <div class="editor-pane">
          <div class="pane-header">Plain Text</div>
          <textarea id="postContent" class="editor-textarea" placeholder="Your blog post content in markdown format..."></textarea>
        </div>
        
        <div class="preview-pane">
          <div class="pane-header">Markdown Preview</div>
          <div id="previewContent" class="preview-content"></div>
        </div>
      </div>
      
      <!-- Button group -->
      <div class="button-group">
        <div>
          <button id="previewButton" class="secondary">Refresh Preview</button>
          <button id="suggestImprovements" class="secondary">Suggest Improvements</button>
          <button id="undoButton" class="secondary" disabled>Undo</button>
          <button id="redoButton" class="secondary" disabled>Redo</button>
          <span id="versionInfo" style="margin-left: 10px; color: #6c757d; font-size: 0.9em;">Version: 1</span>
        </div>
        <div>
          <button id="historyButton" class="secondary">History</button>
          <button id="saveButton" class="success">Save Post</button>
        </div>
      </div>
      
      <!-- Version history modal -->
      <div id="historyModal" class="modal" style="display: none;">
        <div class="modal-content">
          <div class="modal-header">
            <h3>Version History</h3>
            <span class="close-modal">&times;</span>
          </div>
          <div class="modal-body">
            <div id="versionList" class="version-list"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Hidden form for saving -->
  <form id="saveForm" method="post" action="{% url 'blog:save_ai_blog' %}" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="title" id="formTitle">
    <input type="hidden" name="content" id="formContent">
    <input type="hidden" name="author" id="formAuthor">
    <input type="hidden" name="category" id="formCategory">
    <input type="hidden" name="status" id="formStatus">
  </form>
  
  <!-- Loading spinner -->
  <div id="loadingSpinner" class="loading-spinner">
    <div class="spinner"></div>
    <p id="loadingMessage">Processing your request...</p>
  </div>
  
  <script>
    /**
     * AI Blog Editor JavaScript
     * 
     * This script powers the interactive AI-assisted blog post editor.
     * Key features:
     * - Real-time conversation with AI to generate and refine content
     * - Dynamic content updates in the editor from AI suggestions
     * - Preview rendering of markdown content
     * - Content improvement suggestions with diff view
     * - Side-by-side difference comparisons
     * - Toggle previews of improvements
     */
    document.addEventListener('DOMContentLoaded', function() {
      // DOM elements
      const chatMessages = document.getElementById('chatMessages');
      const userInput = document.getElementById('userInput');
      const sendButton = document.getElementById('sendButton');
      const postContent = document.getElementById('postContent');
      const postTitle = document.getElementById('postTitle');
      const postCategory = document.getElementById('postCategory');
      const postAuthor = document.getElementById('postAuthor');
      const postStatus = document.getElementById('postStatus');
      const previewButton = document.getElementById('previewButton');
      const previewContent = document.getElementById('previewContent');
      const saveButton = document.getElementById('saveButton');
      const loadingSpinner = document.getElementById('loadingSpinner');
      const loadingMessage = document.getElementById('loadingMessage');
      const suggestImprovements = document.getElementById('suggestImprovements');
      const undoButton = document.getElementById('undoButton');
      const redoButton = document.getElementById('redoButton');
      const versionInfo = document.getElementById('versionInfo');
      const historyButton = document.getElementById('historyButton');
      const historyModal = document.getElementById('historyModal');
      const versionList = document.getElementById('versionList');
      const closeModal = document.querySelector('.close-modal');
      
      // Initialize the preview on page load
      setTimeout(updatePreview, 500);
      
      /**
       * Version History System
       * 
       * This object manages a complete version history for content in the editor,
       * providing undo/redo functionality and a full history browser.
       * 
       * Key features:
       * - Tracks all content changes with timestamps and source info
       * - Provides undo/redo functionality with UI updates
       * - Offers a version browser with diff view for comparing changes
       * - Supports restoring any historical version
       * - Auto-detects content changes and creates versions intelligently
       */
      const versionHistory = {
        versions: [], // Array to store all versions of content
        currentIndex: -1, // Current position in version history
        
        /**
         * Initialize the version history with the current content
         * Creates the first version (baseline) for the undo/redo system
         */
        init() {
          this.addVersion(postContent.value);
        },
        
        /**
         * Add a new version to the history
         * 
         * @param {string} content - The content to add as a new version
         * @param {string} source - The source of the change ('edit', 'ai', 'undo', 'redo', 'restore')
         * @returns {boolean} - Whether a new version was added
         */
        addVersion(content, source = 'edit') {
          // Don't add duplicate content (same as current version)
          if (this.currentIndex >= 0 && this.versions[this.currentIndex].content === content) {
            return false;
          }
          
          // If we're not at the latest version (user did an undo),
          // remove all versions after current position (standard undo/redo behavior)
          if (this.currentIndex < this.versions.length - 1) {
            this.versions = this.versions.slice(0, this.currentIndex + 1);
          }
          
          // Add the new version with metadata
          this.versions.push({
            content: content,
            timestamp: new Date(),
            source: source  // Tracks where the change came from
          });
          
          // Update current index to point to the new version
          this.currentIndex = this.versions.length - 1;
          
          // Update UI to reflect the new version state
          this.updateUI();
          
          return true;
        },
        
        /**
         * Moves back one version in history (undo operation)
         * 
         * @returns {boolean} - Whether the undo was successful
         */
        undo() {
          // Check if we can go back (not at the beginning of history)
          if (this.currentIndex > 0) {
            this.currentIndex--; // Move back one version
            postContent.value = this.versions[this.currentIndex].content; // Update editor content
            updatePreview(); // Update preview to reflect content
            this.updateUI(); // Update UI elements
            return true;
          }
          return false; // Can't undo (at first version)
        },
        
        /**
         * Moves forward one version in history (redo operation)
         * 
         * @returns {boolean} - Whether the redo was successful
         */
        redo() {
          // Check if we can go forward (not at the end of history)
          if (this.currentIndex < this.versions.length - 1) {
            this.currentIndex++; // Move forward one version
            postContent.value = this.versions[this.currentIndex].content; // Update editor content
            updatePreview(); // Update preview to reflect content
            this.updateUI(); // Update UI elements 
            return true;
          }
          return false; // Can't redo (at last version)
        },
        
        /**
         * Restores a specific version from history by index
         * 
         * @param {number} index - The index of the version to restore
         * @returns {boolean} - Whether the restore was successful
         */
        restoreVersion(index) {
          // Validate index
          if (index >= 0 && index < this.versions.length) {
            // If restoring a previous version, add current as a new version first
            // This allows going back to the current state after restoring
            if (index !== this.currentIndex) {
              // First record where we're restoring from in the history
              this.versions.push({
                content: this.versions[index].content,
                timestamp: new Date(),
                source: 'restore'  // Mark as a restored version
              });
              this.currentIndex = this.versions.length - 1;
            }
            
            // Update content and UI
            postContent.value = this.versions[index].content;
            updatePreview();
            this.updateUI();
            return true;
          }
          return false; // Invalid index
        },
        
        /**
         * Updates the UI elements to reflect the current version state
         * - Enables/disables undo/redo buttons based on position in history
         * - Updates version counter display
         * - Refreshes history modal if it's open
         */
        updateUI() {
          // Update undo/redo buttons state
          undoButton.disabled = this.currentIndex <= 0; // Disable undo if at first version
          redoButton.disabled = this.currentIndex >= this.versions.length - 1; // Disable redo if at last version
          
          // Update version info counter
          versionInfo.textContent = `Version: ${this.currentIndex + 1} of ${this.versions.length}`;
          
          // Update version history list if the modal is open
          if (historyModal.style.display === 'flex') {
            this.renderVersionList();
          }
        },
        
        // Render the version list in the history modal
        renderVersionList() {
          versionList.innerHTML = '';
          
          this.versions.forEach((version, index) => {
            const isActive = index === this.currentIndex;
            const formattedTime = this.formatTimestamp(version.timestamp);
            const sourceLabel = this.getSourceLabel(version.source);
            
            const versionItem = document.createElement('div');
            versionItem.className = `version-item ${isActive ? 'active' : ''}`;
            versionItem.innerHTML = `
              <div class="version-info">
                <div>Version ${index + 1} (${sourceLabel})</div>
                <div class="version-time">${formattedTime}</div>
              </div>
              <div class="version-actions">
                <button class="restore-btn ${isActive ? 'disabled' : ''}" ${isActive ? 'disabled' : ''}>Restore</button>
              </div>
            `;
            
            // Add event listener for restore button
            const restoreBtn = versionItem.querySelector('.restore-btn');
            if (!isActive) {
              restoreBtn.addEventListener('click', (e) => {
                e.stopPropagation();  // Prevent item click from firing
                this.restoreVersion(index);
                historyModal.style.display = 'none';
              });
            }
            
            // Add event listener for item click (preview)
            versionItem.addEventListener('click', () => {
              // Highlight the active item
              document.querySelectorAll('.version-item').forEach(item => {
                item.classList.remove('active');
              });
              versionItem.classList.add('active');
              
              // Show diff between current and selected version
              this.showDiff(index);
            });
            
            versionList.appendChild(versionItem);
          });
        },
        
        // Format timestamp for display
        formatTimestamp(timestamp) {
          const now = new Date();
          const diff = now - timestamp;
          
          // If less than a minute ago, show 'just now'
          if (diff < 60000) {
            return 'just now';
          }
          
          // If less than an hour ago, show minutes
          if (diff < 3600000) {
            const minutes = Math.floor(diff / 60000);
            return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
          }
          
          // Otherwise, show the time
          return timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        },
        
        // Get a human-readable label for the source
        getSourceLabel(source) {
          const labels = {
            'edit': 'Manual Edit',
            'ai': 'AI Generated',
            'undo': 'Undo',
            'redo': 'Redo',
            'restore': 'Restored'
          };
          
          return labels[source] || 'Edit';
        },
        
        // Show diff between two versions
        showDiff(index) {
          if (index < 0 || index >= this.versions.length) return;
          
          const currentContent = this.versions[this.currentIndex].content;
          const selectedContent = this.versions[index].content;
          
          // Create a diff view to show changes
          const diffContainer = document.createElement('div');
          diffContainer.className = 'diff-container';
          
          // Add header with information about the versions
          const diffHeader = document.createElement('div');
          diffHeader.className = 'diff-header';
          diffHeader.innerHTML = `
            <h4>Changes between Version ${index + 1} and Version ${this.currentIndex + 1}</h4>
            <div class="diff-legend">
              <span class="diff-removed">Removed</span>
              <span class="diff-added">Added</span>
            </div>
          `;
          diffContainer.appendChild(diffHeader);
          
          // Split content into lines
          const currentLines = currentContent.split('\n');
          const selectedLines = selectedContent.split('\n');
          
          // Simple line-by-line diff
          const diffContent = document.createElement('div');
          diffContent.className = 'diff-content';
          
          // Find the max length of both arrays
          const maxLines = Math.max(currentLines.length, selectedLines.length);
          
          for (let i = 0; i < maxLines; i++) {
            const currentLine = i < currentLines.length ? currentLines[i] : '';
            const selectedLine = i < selectedLines.length ? selectedLines[i] : '';
            
            if (currentLine !== selectedLine) {
              // Lines are different
              if (selectedLine) {
                const oldLine = document.createElement('div');
                oldLine.className = 'diff-line diff-removed';
                oldLine.textContent = selectedLine;
                diffContent.appendChild(oldLine);
              }
              
              if (currentLine) {
                const newLine = document.createElement('div');
                newLine.className = 'diff-line diff-added';
                newLine.textContent = currentLine;
                diffContent.appendChild(newLine);
              }
            } else {
              // Lines are the same
              const unchangedLine = document.createElement('div');
              unchangedLine.className = 'diff-line';
              unchangedLine.textContent = currentLine;
              diffContent.appendChild(unchangedLine);
            }
          }
          
          diffContainer.appendChild(diffContent);
          
          // Add actions buttons
          const diffActions = document.createElement('div');
          diffActions.className = 'diff-actions';
          diffActions.innerHTML = `
            <button class="restore-version">Restore Version ${index + 1}</button>
            <button class="close-diff">Close</button>
          `;
          diffContainer.appendChild(diffActions);
          
          // Add event listeners for buttons
          diffActions.querySelector('.restore-version').addEventListener('click', () => {
            this.restoreVersion(index);
            
            // Remove the diff view
            if (document.querySelector('.diff-container')) {
              document.querySelector('.diff-container').remove();
            }
          });
          
          diffActions.querySelector('.close-diff').addEventListener('click', () => {
            // Remove the diff view
            if (document.querySelector('.diff-container')) {
              document.querySelector('.diff-container').remove();
            }
          });
          
          // Remove any existing diff view
          if (document.querySelector('.diff-container')) {
            document.querySelector('.diff-container').remove();
          }
          
          // Add the diff view to the modal
          document.querySelector('.modal-body').appendChild(diffContainer);
        }
      };
      
      // Initialize version history with current content
      setTimeout(() => {
        versionHistory.init();
      }, 1000);
      
      // CSRF token function
      function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
      }
      
      // Add message to chat
      function addMessage(content, type) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        messageDiv.innerHTML = `<p>${content}</p>`;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      
      /**
       * Renders the markdown content as HTML in the preview tab
       * 
       * This function:
       * 1. Shows a loading spinner while processing
       * 2. Sends the current editor content to the server for markdown rendering
       * 3. Updates the preview pane with the rendered HTML
       * 4. Includes the current title in the preview
       */
      function updatePreview() {
        // Show loading indicator in the preview panel
        previewContent.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner" style="display: inline-block;"></div><p>Updating preview...</p></div>';
        
        fetch('{% url "blog:markdown_preview" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          },
          body: JSON.stringify({
            content: postContent.value
          })
        })
        .then(response => response.json())
        .then(data => {
          // Don't manually add the title since it's already in the content
          previewContent.innerHTML = data.html;
        })
        .catch(error => {
          console.error('Error generating preview:', error);
          previewContent.innerHTML = '<div style="color: red; padding: 20px;">Error generating preview. Please try again.</div>';
        });
      }
      
      /**
       * Handles user message submission to the AI
       * 
       * This function:
       * 1. Sends the user's message to the AI along with the current blog state
       * 2. Shows a loading spinner during processing
       * 3. Adds the AI's response to the chat window
       * 4. Updates the editor content with the AI's blog post
       * 5. Updates the title field if a title is suggested
       * 6. Attempts to detect and set the category from content
       * 
       * The AI returns two sections:
       * - A conversational response shown in the chat
       * - A complete blog post that updates the editor
       */
      function handleUserMessage() {
        const message = userInput.value.trim();
        
        if (!message) {
          return;
        }
        
        // Add user message to chat
        addMessage(message, 'user');
        
        // Clear input
        userInput.value = '';
        
        // Show loading spinner
        loadingSpinner.style.display = 'flex';
        loadingMessage.textContent = 'AI is thinking...';
        
        // Get current content and metadata
        const title = postTitle.value;
        const content = postContent.value;
        const category = postCategory.options[postCategory.selectedIndex]?.text || '';
        
        // Send request to AI
        fetch('{% url "blog:ai_blog_conversation" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          },
          body: JSON.stringify({
            message: message,
            title: title,
            content: content,
            category: category
          })
        })
        .then(response => response.json())
        .then(data => {
          // Hide loading spinner
          loadingSpinner.style.display = 'none';
          
          if (data.error) {
            // Handle error
            addMessage(`Error: ${data.error}`, 'system');
            return;
          }
          
          // Add AI response to chat
          addMessage(data.reply, 'ai');
          
          // Update content if provided
          if (data.content) {
            console.log("Updating content with new content:", data.content.substring(0, 100) + "...");
            
            // Store the previous content for comparison
            const previousContent = postContent.value;
            const isFirstContent = !previousContent.trim();
            
            // Update editor with the new content
            postContent.value = data.content;
            
            // Update the preview as well
            updatePreview();
            
            // Add a new version to history
            versionHistory.addVersion(data.content, 'ai');
            
            // Add an appropriate system message based on whether this is the first content or an update
            if (isFirstContent) {
              addMessage("‚ú® Blog post created in the editor! You can now edit or refine it.", "system");
              
              // Add a hint about the side-by-side editor
              setTimeout(() => {
                addMessage("Tip: Your content appears in the editor on the left and the preview on the right. Changes update automatically.", "system");
              }, 1500);
            } else {
              addMessage("üìù Blog post updated in the editor", "system");
              
              // Offer to show what changed
              const diffMsg = document.createElement('div');
              diffMsg.className = 'message system';
              diffMsg.innerHTML = `<p><a href="#" id="showDiff" style="color: #0275d8; text-decoration: underline;">Show what changed</a></p>`;
              chatMessages.appendChild(diffMsg);
              
              // Add event listener to show changes
              document.getElementById('showDiff').addEventListener('click', function(e) {
                e.preventDefault();
                
                // Show differences between previous and current
                const previousLines = previousContent.split("\n");
                const currentLines = data.content.split("\n");
                
                // Create a simple diff view
                let diffHTML = '<div style="font-family: monospace; white-space: pre-wrap; line-height: 1.4;">';
                
                // Find the max length
                const maxLength = Math.max(previousLines.length, currentLines.length);
                
                for (let i = 0; i < maxLength; i++) {
                  const previousLine = i < previousLines.length ? previousLines[i] : '';
                  const currentLine = i < currentLines.length ? currentLines[i] : '';
                  
                  if (previousLine !== currentLine) {
                    // Lines are different
                    if (previousLine) {
                      diffHTML += `<div style="background-color: #ffdddd; text-decoration: line-through;">${previousLine}</div>`;
                    }
                    if (currentLine) {
                      diffHTML += `<div style="background-color: #ddffdd;">${currentLine}</div>`;
                    }
                  } else {
                    // Lines are the same
                    diffHTML += `<div>${currentLine}</div>`;
                  }
                }
                
                diffHTML += '</div>';
                
                // Show the diff in a special message
                const diffDetailMsg = document.createElement('div');
                diffDetailMsg.className = 'message system';
                diffDetailMsg.innerHTML = `
                  <p><strong>Changes Made:</strong></p>
                  <div style="max-height: 300px; overflow-y: auto; margin: 10px 0; border: 1px solid #ddd; padding: 10px;">
                    ${diffHTML}
                  </div>
                  <p>Red = removed, Green = added</p>
                `;
                chatMessages.appendChild(diffDetailMsg);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Remove the "Show what changed" link
                diffMsg.style.display = 'none';
              });
            }
            
            // We'll no longer auto-switch to the preview tab to avoid confusion with preview timeouts
          }
          
          // Update title if provided
          if (data.title) {
            console.log("Updating title to:", data.title);
            // Always update if empty or if overwrite flag is set
            if (!postTitle.value || data.overwrite_title) {
              postTitle.value = data.title;
              addMessage(`Title has been set to: "${data.title}"`, "system");
            } else {
              // Suggest the title but don't automatically change it
              addMessage(`Suggested title: "${data.title}" (click to use)`, "system");
              
              // Make the message clickable to update the title
              const messages = chatMessages.querySelectorAll('.message.system');
              const lastMessage = messages[messages.length - 1];
              lastMessage.style.cursor = 'pointer';
              lastMessage.addEventListener('click', function() {
                postTitle.value = data.title;
                this.innerHTML = `<p>Title has been updated to: "${data.title}"</p>`;
                this.style.backgroundColor = '#28a745';
                this.style.color = 'white';
              });
            }
          }
          
          // If category is empty, try to extract from content
          if (!postCategory.value && category === '') {
            // Look for category indicators in the content
            const categoryNames = Array.from(postCategory.options).map(opt => opt.text.toLowerCase());
            
            // Skip the first "Select Category" option
            categoryNames.shift();
            
            // Check if any category name is mentioned in the content or response
            const contentToCheck = (data.content || '') + ' ' + data.reply.toLowerCase();
            
            for (let i = 0; i < categoryNames.length; i++) {
              if (contentToCheck.toLowerCase().includes(categoryNames[i])) {
                // Found a category match
                const categoryOption = Array.from(postCategory.options).find(
                  opt => opt.text.toLowerCase() === categoryNames[i]
                );
                
                if (categoryOption) {
                  postCategory.value = categoryOption.value;
                  addMessage(`Category set to: ${categoryOption.text}`, "system");
                  break;
                }
              }
            }
          }
        })
        .catch(error => {
          console.error('Error:', error);
          loadingSpinner.style.display = 'none';
          addMessage('An error occurred while communicating with the AI. Please try again.', 'system');
        });
      }
      
      /**
       * Requests and handles AI improvement suggestions for the current content
       * 
       * This function provides an advanced content improvement workflow:
       * 1. Sends the current content to the AI for analysis
       * 2. Displays the AI's improvement suggestions in the chat
       * 3. Offers three options for reviewing the improvements:
       *    - Apply Changes: Updates the editor with improved content
       *    - Preview Changes: Toggle between original and improved versions
       *    - Show Differences: Side-by-side comparison with highlighted changes
       * 
       * Each option has its own interactive UI for clear user feedback
       */
      function suggestPostImprovements() {
        const content = postContent.value.trim();
        
        if (!content) {
          alert('Please write some content first before requesting improvements.');
          return;
        }
        
        // Add message to chat
        addMessage('Can you suggest improvements for this content?', 'user');
        
        // Show loading spinner
        loadingSpinner.style.display = 'flex';
        loadingMessage.textContent = 'Analyzing your content...';
        
        // Send request to AI
        fetch('{% url "blog:ai_blog_improve" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          },
          body: JSON.stringify({
            content: content,
            title: postTitle.value
          })
        })
        .then(response => response.json())
        .then(data => {
          // Hide loading spinner
          loadingSpinner.style.display = 'none';
          
          if (data.error) {
            // Handle error
            addMessage(`Error: ${data.error}`, 'system');
            return;
          }
          
          // Add AI response to chat
          addMessage(data.suggestions, 'ai');
          
          // Update content if provided
          if (data.improved_content) {
            // Create a special system message with buttons
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.innerHTML = `
              <p>The AI has suggested improvements to your content.</p>
              <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="apply-btn" style="background-color: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Apply Changes</button>
                <button class="preview-btn" style="background-color: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Preview Changes</button>
                <button class="diff-btn" style="background-color: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Show Differences</button>
              </div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Add event listeners to buttons
            messageDiv.querySelector('.apply-btn').addEventListener('click', function() {
              postContent.value = data.improved_content;
              this.parentNode.innerHTML = '<p>‚úÖ Improvements applied to the editor</p>';
              this.parentNode.parentNode.style.backgroundColor = '#28a745';
              this.parentNode.parentNode.style.color = 'white';
            });
            
            messageDiv.querySelector('.preview-btn').addEventListener('click', function() {
              // Store the original content
              const originalContent = postContent.value;
              let isShowingImproved = false;
              let previewBanner = null;
              
              // Create a toggle banner with buttons
              previewBanner = document.createElement('div');
              previewBanner.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background-color: #17a2b8; color: white; padding: 10px; text-align: center; z-index: 9999; display: flex; justify-content: center; align-items: center; gap: 20px;';
              previewBanner.innerHTML = `
                <div style="font-weight: bold;">PREVIEW MODE: <span id="previewStatus">Original Content</span></div>
                <div>
                  <button id="togglePreviewBtn" style="background-color: white; color: #17a2b8; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-weight: bold;">Show Improved</button>
                  <button id="applyPreviewBtn" style="background-color: #28a745; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: 10px;">Apply Improved</button>
                  <button id="exitPreviewBtn" style="background-color: #dc3545; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: 10px;">Exit Preview</button>
                </div>
              `;
              document.body.appendChild(previewBanner);
              
              // Add a system message
              const tempMsg = document.createElement('div');
              tempMsg.className = 'message system';
              tempMsg.innerHTML = `
                <p><strong>Preview Mode Active</strong></p>
                <p>Use the toggle button in the banner to switch between original and improved content.</p>
              `;
              chatMessages.appendChild(tempMsg);
              chatMessages.scrollTop = chatMessages.scrollHeight;
              
              // Show preview tab to see the content
              document.querySelector('.editor-tab[data-tab="preview"]').click();
              
              // Toggle function
              function togglePreview() {
                isShowingImproved = !isShowingImproved;
                
                if (isShowingImproved) {
                  postContent.value = data.improved_content;
                  document.getElementById('previewStatus').textContent = 'Improved Content';
                  document.getElementById('togglePreviewBtn').textContent = 'Show Original';
                } else {
                  postContent.value = originalContent;
                  document.getElementById('previewStatus').textContent = 'Original Content';
                  document.getElementById('togglePreviewBtn').textContent = 'Show Improved';
                }
                
                // Refresh the preview if in preview tab
                if (document.querySelector('.editor-tab[data-tab="preview"]').classList.contains('active')) {
                  updatePreview();
                }
              }
              
              // Set up event listeners for the banner buttons
              document.getElementById('togglePreviewBtn').addEventListener('click', togglePreview);
              
              document.getElementById('applyPreviewBtn').addEventListener('click', function() {
                // Apply the improved content permanently
                postContent.value = data.improved_content;
                
                // Update the message
                tempMsg.innerHTML = '<p>‚úÖ Improvements applied to the editor</p>';
                tempMsg.style.backgroundColor = '#28a745';
                tempMsg.style.color = 'white';
                
                // Remove the banner
                document.body.removeChild(previewBanner);
                
                // Update the original message
                messageDiv.innerHTML = '<p>‚úÖ Improvements have been applied to the editor</p>';
                messageDiv.style.backgroundColor = '#28a745';
                messageDiv.style.color = 'white';
              });
              
              document.getElementById('exitPreviewBtn').addEventListener('click', function() {
                // Restore original content
                postContent.value = originalContent;
                
                // Switch back to editor tab
                document.querySelector('.editor-tab[data-tab="editor"]').click();
                
                // Update the message
                tempMsg.innerHTML = '<p>Preview mode exited. Original content restored.</p>';
                
                // Remove the banner
                document.body.removeChild(previewBanner);
              });
              
              // Initial toggle to show improved content
              togglePreview();
            });
            
            messageDiv.querySelector('.diff-btn').addEventListener('click', function() {
              // Store the original content and editor tab state
              const originalContent = postContent.value;
              const wasInPreviewTab = document.querySelector('.editor-tab[data-tab="preview"]').classList.contains('active');
              
              // First, ensure we're on the editor tab
              document.querySelector('.editor-tab[data-tab="editor"]').click();
              
              // Create a diff view container in the editor area
              const editorContainer = document.querySelector('.editor-content');
              const originalEditorTab = document.getElementById('editorTab');
              const previewTab = document.getElementById('previewTab');
              
              // Create and add the diff tab if it doesn't exist
              let diffTab = document.getElementById('diffTab');
              if (!diffTab) {
                diffTab = document.createElement('div');
                diffTab.id = 'diffTab';
                diffTab.className = 'tab-content';
                diffTab.style.display = 'none';
                editorContainer.appendChild(diffTab);
                
                // Also add the diff tab button
                const tabsContainer = document.querySelector('.editor-tabs');
                const diffTabBtn = document.createElement('div');
                diffTabBtn.className = 'editor-tab';
                diffTabBtn.setAttribute('data-tab', 'diff');
                diffTabBtn.textContent = 'Diff View';
                diffTabBtn.addEventListener('click', function() {
                  // Remove active class from all tabs
                  document.querySelectorAll('.editor-tab').forEach(t => t.classList.remove('active'));
                  
                  // Add active class to this tab
                  this.classList.add('active');
                  
                  // Hide all tab contents
                  document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
                  
                  // Show diff tab content
                  document.getElementById('diffTab').style.display = 'block';
                });
                tabsContainer.appendChild(diffTabBtn);
              }
              
              // Show differences between original and improved
              const originalLines = originalContent.split("\n");
              const improvedLines = data.improved_content.split("\n");
              
              // Create a side-by-side diff view
              let diffHTML = `
                <div style="display: flex; height: 100%; border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                  <div style="flex: 1; padding: 10px; border-right: 1px solid #ddd; overflow: auto; max-height: 500px;">
                    <h3 style="position: sticky; top: 0; background: white; padding: 5px 0; margin-top: 0;">Original</h3>
                    <div style="font-family: monospace; white-space: pre-wrap; line-height: 1.4;">
              `;
              
              // Add original content with highlighted changes
              for (let i = 0; i < originalLines.length; i++) {
                const line = originalLines[i];
                const improvedLine = i < improvedLines.length ? improvedLines[i] : '';
                
                if (line !== improvedLine) {
                  // Line is different
                  diffHTML += `<div style="background-color: #ffdddd;">${line}</div>`;
                } else {
                  // Line is the same
                  diffHTML += `<div>${line}</div>`;
                }
              }
              
              diffHTML += `
                    </div>
                  </div>
                  <div style="flex: 1; padding: 10px; overflow: auto; max-height: 500px;">
                    <h3 style="position: sticky; top: 0; background: white; padding: 5px 0; margin-top: 0;">Improved</h3>
                    <div style="font-family: monospace; white-space: pre-wrap; line-height: 1.4;">
              `;
              
              // Add improved content with highlighted changes
              for (let i = 0; i < improvedLines.length; i++) {
                const line = improvedLines[i];
                const originalLine = i < originalLines.length ? originalLines[i] : '';
                
                if (line !== originalLine) {
                  // Line is different
                  diffHTML += `<div style="background-color: #ddffdd;">${line}</div>`;
                } else {
                  // Line is the same
                  diffHTML += `<div>${line}</div>`;
                }
              }
              
              diffHTML += `
                    </div>
                  </div>
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                  <button id="applyDiffChanges" style="background-color: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Apply Improved Version</button>
                  <button id="closeDiffView" style="background-color: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Return to Editor</button>
                </div>
              `;
              
              // Set the diff content and show the diff tab
              diffTab.innerHTML = diffHTML;
              
              // Hide editor and preview tabs, show diff tab
              originalEditorTab.style.display = 'none';
              previewTab.style.display = 'none';
              diffTab.style.display = 'block';
              
              // Update the tabs to show diff tab as active
              document.querySelectorAll('.editor-tab').forEach(tab => tab.classList.remove('active'));
              document.querySelector('.editor-tab[data-tab="diff"]').classList.add('active');
              
              // Add event listeners for the diff view buttons
              document.getElementById('applyDiffChanges').addEventListener('click', function() {
                // Apply the improved content
                postContent.value = data.improved_content;
                
                // Hide the diff view and return to editor
                diffTab.style.display = 'none';
                originalEditorTab.style.display = 'block';
                
                // Update the tab buttons
                document.querySelectorAll('.editor-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.editor-tab[data-tab="editor"]').classList.add('active');
                
                // Update the system message
                messageDiv.innerHTML = '<p>‚úÖ Improvements have been applied to the editor</p>';
                messageDiv.style.backgroundColor = '#28a745';
                messageDiv.style.color = 'white';
                
                // Add a confirmation message
                const confirmMsg = document.createElement('div');
                confirmMsg.className = 'message system';
                confirmMsg.innerHTML = '<p>Changes have been applied to the editor.</p>';
                confirmMsg.style.backgroundColor = '#28a745';
                confirmMsg.style.color = 'white';
                chatMessages.appendChild(confirmMsg);
                chatMessages.scrollTop = chatMessages.scrollHeight;
              });
              
              document.getElementById('closeDiffView').addEventListener('click', function() {
                // Hide the diff view and return to editor
                diffTab.style.display = 'none';
                originalEditorTab.style.display = 'block';
                
                // Update the tab buttons
                document.querySelectorAll('.editor-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.editor-tab[data-tab="editor"]').classList.add('active');
                
                // If user was in preview tab before, return there
                if (wasInPreviewTab) {
                  setTimeout(() => {
                    document.querySelector('.editor-tab[data-tab="preview"]').click();
                  }, 10);
                }
              });
              
              // Add a system message
              addMessage(`Diff view opened in the editor. Red = original text, Green = improved text.`, 'system');
            });
          }
        })
        .catch(error => {
          console.error('Error:', error);
          loadingSpinner.style.display = 'none';
          addMessage('An error occurred while analyzing your content. Please try again.', 'system');
        });
      }
      
      // Save post
      function savePost() {
        const title = postTitle.value.trim();
        const content = postContent.value.trim();
        const author = postAuthor.value;
        const category = postCategory.value;
        const status = postStatus.value;
        
        if (!title) {
          alert('Please enter a title for your blog post.');
          return;
        }
        
        if (!content) {
          alert('Please enter content for your blog post.');
          return;
        }
        
        if (!author) {
          alert('Please select an author for your blog post.');
          return;
        }
        
        // Set form values
        document.getElementById('formTitle').value = title;
        document.getElementById('formContent').value = content;
        document.getElementById('formAuthor').value = author;
        document.getElementById('formCategory').value = category;
        document.getElementById('formStatus').value = status;
        
        // Submit the form
        document.getElementById('saveForm').submit();
      }
      
      // Event listeners
      sendButton.addEventListener('click', handleUserMessage);
      
      userInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          handleUserMessage();
        }
      });
      
      /**
       * Event listener for content changes in the editor
       * - Updates the preview with a 1-second debounce (for performance)
       * - Creates new versions after 3 seconds of inactivity (avoids creating
       *   a version for every keystroke while still tracking meaningful changes)
       */
      postContent.addEventListener('input', function() {
        // Debounce the preview update (prevent too many requests)
        clearTimeout(this.debounce);
        this.debounce = setTimeout(function() {
          // Update the preview with the current content
          updatePreview();
          
          // Debounce version creation (only create after user stops typing)
          clearTimeout(postContent.versionDebounce);
          postContent.versionDebounce = setTimeout(function() {
            // Create a new version after 3 seconds of inactivity
            versionHistory.addVersion(postContent.value, 'edit');
          }, 3000); // 3-second inactivity timer for version creation
        }, 1000); // 1-second debounce for preview update
      });
      
      // Modal event listeners
      historyButton.addEventListener('click', function() {
        versionHistory.renderVersionList();
        historyModal.style.display = 'flex';
      });
      
      closeModal.addEventListener('click', function() {
        historyModal.style.display = 'none';
      });
      
      // Close modal when clicking outside content
      historyModal.addEventListener('click', function(e) {
        if (e.target === historyModal) {
          historyModal.style.display = 'none';
        }
      });
      
      // Undo/Redo buttons
      undoButton.addEventListener('click', function() {
        versionHistory.undo();
      });
      
      redoButton.addEventListener('click', function() {
        versionHistory.redo();
      });
      
      // Handle keyboard shortcuts for undo/redo
      document.addEventListener('keydown', function(e) {
        // Don't capture keystrokes when focused on inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
          // But still capture Ctrl+Z and Ctrl+Y in the post content editor
          if (e.target === postContent) {
            if (e.ctrlKey && e.key === 'z') {
              e.preventDefault();
              versionHistory.undo();
            } else if (e.ctrlKey && e.key === 'y') {
              e.preventDefault();
              versionHistory.redo();
            }
          }
          return;
        }
        
        // Global keyboard shortcuts
        if (e.ctrlKey && e.key === 'z') {
          e.preventDefault();
          versionHistory.undo();
        } else if (e.ctrlKey && e.key === 'y') {
          e.preventDefault();
          versionHistory.redo();
        }
      });
      
      previewButton.addEventListener('click', updatePreview);
      suggestImprovements.addEventListener('click', suggestPostImprovements);
      saveButton.addEventListener('click', savePost);
    });
  </script>
  {% endif %}
</div>
{% endblock %}